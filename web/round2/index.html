<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>第二輪選制測試｜Top4 專案</title>
  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="../style.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
  <script type="module">
    import { renderSiteNav } from '../shared/nav.js';
    renderSiteNav({ container: document.getElementById('siteNav') });
  </script>
  <script>
    // Embed mode: /web/round2/?embed=matrix
    (function () {
      try {
        const p = new URLSearchParams(window.location.search);
        const mode = p.get('embed');
        if (mode) document.documentElement.dataset.embed = mode;
      } catch {
        // ignore
      }
    })();
  </script>
  <script type="module" defer src="./app.js"></script>
</head>
<body data-page="round2">
  <header class="header">
    <div class="container">
      <nav class="nav" id="siteNav"></nav>
      <h1>第二輪選制測試（不含第一輪初選）</h1>
      <p class="sub">調整各排序選項得票，對比不同選制在「第二輪」的結算過程與結果。</p>
    </div>
  </header>

  <main id="main" class="container">
    <section class="card overflowVisible">
      <div class="controls">
        <div class="field">
          <label for="system">第二輪選制</label>
          <select id="system">
            <option value="plurality">簡單多數（只看第一名）</option>
            <option value="irv" selected>IRV（即時決選 / 排序投票）</option>
            <option value="minimax">Minimax（孔多賽一致；最大反對票數最小化）</option>
            <option value="rankedPairs">Ranked Pairs（孔多賽一致；鎖定排序）</option>
            <option value="benham">Benham（孔多賽一致；有孔多賽優勝者則直接當選）</option>
            <option value="borda">Borda（波達計分）</option>
          </select>
        </div>

        <div class="field">
          <label for="candidateCount">候選人數（2～4）</label>
          <select id="candidateCount">
            <option value="2">2 人（2 選項）</option>
            <option value="3">3 人（6 選項）</option>
            <option value="4" selected>4 人（24 選項）</option>
          </select>
        </div>

        <div class="field">
          <label>選項查詢器（平時隱藏）</label>
          <details id="finderDetails" class="details">
            <summary>查詢排序對應選項</summary>
            <div class="detailsBody">
              <div id="finderSelects" class="finderGrid"></div>
              <div class="finderActions">
                <button id="finderGo" class="btn secondary" type="button">查詢</button>
                <div id="finderResult" class="small"></div>
              </div>
            </div>
          </details>
        </div>

        <div class="field nameField">
          <label>候選人名字（可改）</label>
          <div class="nameGrid">
            <input id="nameA" class="nameInput" value="王小明" />
            <input id="nameB" class="nameInput" value="李小華" />
            <input id="nameC" class="nameInput" value="陳小傑" />
            <input id="nameD" class="nameInput" value="林小美" />
          </div>
        </div>

        <div class="field">
          <label for="preset">範例</label>
          <select id="preset">
            <option value="blank" selected>空白（全 0）</option>
            <option value="demo">Demo（隨機、可重算）</option>
          </select>
        </div>

        <div class="field randomField">
          <label>隨機產生條件</label>
          <details id="randomSettings" class="details">
            <summary>設定</summary>
            <div class="detailsBody">
              <div class="detailsGrid">
                <div>
                  <div class="small">總票數（目標）</div>
                  <input id="randTotal" class="miniInput" type="number" min="0" step="1" value="120" />
                </div>
                <div>
                  <div class="small">每選項最大票數</div>
                  <input id="randMax" class="miniInput" type="number" min="0" step="1" value="30" />
                </div>
                <div>
                  <div class="small">零票比例（0~1）</div>
                  <input id="randZero" class="miniInput" type="number" min="0" max="1" step="0.05" value="0.55" />
                </div>
                <div>
                  <div class="small">集中度（越大越集中）</div>
                  <input id="randBias" class="miniInput" type="number" min="0.2" max="5" step="0.1" value="1.2" />
                </div>
              </div>
              <div class="small" style="margin-top:10px">
                提示：零票比例越高越稀疏；集中度越大，票更容易集中在少數選項。
              </div>
              <div id="randStatus" class="small" style="margin-top:10px; display:none"></div>
            </div>
          </details>
        </div>

        <div class="field">
          <label>總票數</label>
          <div id="totalVotes" class="pill">0</div>
        </div>

        <div class="field right">
          <button id="purpose" class="btn secondary">這頁在測什麼？</button>
          <button id="reset" class="btn">全部歸零</button>
          <button id="randomize" class="btn secondary">隨機產生</button>
        </div>
      </div>

      <div class="stack">
        <div>
          <h2 class="h2">矩陣票（完整排序）</h2>
          <details class="summaryDetails" open>
            <summary>顯示/隱藏：矩陣票（完整排序）</summary>
            <p class="hint">上方可「勾選」一個選項以聚焦查看；票數請在「票數」列輸入整數。4 人/24 選項時會分成兩排（每排 12 選項）避免超出螢幕。</p>
            <div class="tableWrap">
              <div id="matrixTables" class="matrixTables" aria-label="矩陣票"></div>
            </div>

            <div class="small" style="margin-top:8px">
              為了避免在螢幕上橫向超出，本頁在 4 人/24 選項時分成兩排顯示（每排 12 選項）。
              但在「直接選舉」情境下，我仍採用 <b>單排顯示</b> 以方便人工計票與查找。
            </div>
          </details>
        </div>

        <div>
          <h2 class="h2">即時摘要</h2>
          <details class="summaryDetails" open>
            <summary>顯示/隱藏：即時摘要</summary>
            <div id="summary" class="summary"></div>
          </details>

          <h2 class="h2">IRV 多輪 Sankey</h2>
          <details class="summaryDetails" open>
            <summary>顯示/隱藏：IRV 多輪 Sankey</summary>
            <div id="irvViz" class="viz">
              <div class="vizHeader">
                <div class="hint">每一輪顯示當輪計入的票流；被淘汰者的票會依下一名轉移。把鼠標移到色塊上可看累積票數與百分比。</div>
              </div>
              <div id="sankeyContainer" class="sankey"></div>
            </div>
          </details>

          <div id="rpSection" style="display:none">
            <h2 class="h2">Ranked Pairs 視覺化</h2>
            <details class="summaryDetails" open>
              <summary>顯示/隱藏：Ranked Pairs 視覺化</summary>
              <div id="rpViz" class="viz" style="display:none">
                <div class="vizHeader">
                  <div class="hint">用節點與箭頭表示鎖定後的勝負關係，並列出最終排序。</div>
                </div>
                <div class="rpWrap">
                  <div>
                    <div class="small" style="margin-bottom:6px">Pairwise 矩陣</div>
                    <div id="pairwiseContainer" class="pairwise"></div>
                  </div>
                  <div>
                    <div class="small" style="margin-bottom:6px">勝負圖（已標記鎖定）</div>
                    <div id="rpGraphContainer" class="rpGraph"></div>
                    <div class="small" style="margin-bottom:6px">Ranked Pairs 排名</div>
                    <div id="rpOrder" class="rpOrder"></div>
                    <div class="small" style="margin:8px 0 6px">孔多賽排名</div>
                    <div id="condorcetOrder" class="rpOrder"></div>
                  </div>
                </div>
              </div>
            </details>
          </div>

          <div id="condorcetSection">
            <h2 class="h2">兩兩對決 / 孔多賽排名</h2>
            <details class="summaryDetails" open>
              <summary>顯示/隱藏：兩兩對決 / 孔多賽排名</summary>
              <div id="condorcetViz" class="viz">
                <div class="vizHeader">
                  <div class="hint">用 pairwise 矩陣觀察兩兩對決結果，並依勝場數給出孔多賽排序（含平手註記）。</div>
                </div>
                <div class="rpWrap">
                  <div>
                    <div class="small" style="margin-bottom:6px">Pairwise 矩陣</div>
                    <div id="condorcetPairwise" class="pairwise"></div>
                  </div>
                  <div>
                    <div class="small" style="margin-bottom:6px">勝負圖（pairwise arrows）</div>
                    <div id="condorcetGraph" class="rpGraph"></div>
                    <div class="small" style="margin-bottom:6px">孔多賽排名</div>
                    <div id="condorcetOrderStandalone" class="rpOrder"></div>
                  </div>
                </div>
              </div>
            </details>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 class="h2">結算過程與結果</h2>
      <details class="summaryDetails" open>
        <summary>顯示/隱藏：結算過程與結果</summary>
        <div id="explain" class="explain"></div>
      </details>
    </section>

    <footer class="footer">
      <div class="container footerInner">
        <div>建議用本機 HTTP server 開啟（避免 ES Module 在 file:// 受限）。</div>
        <div class="muted">IRV Sankey 使用 d3-sankey（CDN）。</div>
      </div>
    </footer>
  </main>

  <dialog id="purposeDialog" class="dialog">
    <div class="dialogBody">
      <div class="dialogHeader">
        <h2 class="h2" style="margin:0">這頁在測什麼？</h2>
        <button id="purposeClose" class="btn">關閉</button>
      </div>
      <div class="dialogContent">
        <p style="margin-top:0">
          這一頁用來 <b>單獨測試第二輪選制</b>：你在上方「矩陣票（完整排序）」輸入每種排序各有幾票，本頁會用不同選制計算，並顯示結算過程與結果。
        </p>
        <ul style="margin:0; padding-left: 18px">
          <li>按本專案假設：若總候選人數 ≤ 1，視為無需辦理選舉；因此本頁只處理 2～4 人。</li>
          <li>本頁支援 2～4 人：2 人有 2 種完整排序、3 人有 6 種、4 人有 24 種。</li>
          <li><b>本頁不包含第一輪</b>：第一輪的功能只有「把候選人縮減到 4 人」。若總候選人數為 2～4，第一輪沒有篩選效果，所以<b>直接跳過第一輪</b>。</li>
          <li>第一輪只在候選人過多時才需要：候選人太多會讓選票過長、人工計票與查找變困難，最後可能被迫集中或改成電子計票，進而增加對選制的不信任。</li>
          <li>兩輪 Top4 概念：第一輪用簡單多數（每張票只選 1 位，不排序）選出 4 人；第二輪用完整排序票的選制決定勝者。</li>
        </ul>
      </div>
    </div>
  </dialog>

</body>
</html>
